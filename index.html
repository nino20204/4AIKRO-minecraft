<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STORE 4AIKRO - Mobile Optimized</title>
    <meta name="description" content="STORE 4AIKRO - The ultimate store for Minecraft mods.">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1P984G5247"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1P984G5247');
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Tajawal:wght@500;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #00e676;
            --secondary-color: #4CAF50;
            --bg-dark: #050505;
            --bronze-color: #cd7f32;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-dark); color: white;
            overflow-x: hidden; min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* Background */
        .bg-animation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; z-index: -1;
        }
        .bg-animation::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(0,230,118,0.03) 0%, transparent 60%);
            animation: rotateBG 40s linear infinite;
        }
        @keyframes rotateBG { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* Header */
        .global-user-bar {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(20px);
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            z-index: 1000; border-bottom: 1px solid #111;
            height: 60px; /* Fixed height for stability */
        }
        
        .brand-logo { 
            font-family: 'Tajawal', sans-serif; font-size: 1.4em; font-weight: 900; 
            background: linear-gradient(to right, #fff, #00e676); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            cursor: pointer; letter-spacing: 1px;
        }
        
        .auth-actions { display: flex; gap: 8px; }
        
        .user-btn {
            background: rgba(255, 255, 255, 0.08); color: white; border: none;
            padding: 6px 12px; border-radius: 10px; cursor: pointer; font-family: 'Cairo', sans-serif;
            font-size: 0.85em; display: flex; align-items: center; gap: 6px; 
            font-weight: 700; text-decoration: none;
            min-width: 40px; justify-content: center;
        }
        .user-btn:active { transform: scale(0.95); }
        
        .user-btn.profile-btn { background: rgba(0, 230, 118, 0.15); border: 1px solid rgba(0, 230, 118, 0.3); }
        
        .user-btn.logout-btn { background: rgba(255, 50, 50, 0.1); color: #ff5555; padding: 6px 10px; }

        .key-badge { background: var(--bronze-color); color: white; padding: 2px 6px; border-radius: 15px; font-size: 0.75em; }

        /* Landing */
        #landing-page { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 80px 15px 40px 15px; }
        
        .landing-logo { width: 100px; height: 100px; border-radius: 50%; border: 2px solid rgba(0, 230, 118, 0.3); box-shadow: 0 0 30px rgba(0, 230, 118, 0.2); margin-bottom: 20px; animation: pulseLogo 3s infinite; }
        @keyframes pulseLogo { 0% { box-shadow: 0 0 20px rgba(0, 230, 118, 0.1); } 50% { box-shadow: 0 0 40px rgba(0, 230, 118, 0.4); } 100% { box-shadow: 0 0 20px rgba(0, 230, 118, 0.1); } }

        .landing-title { font-size: 2.2em; margin-bottom: 10px; background: linear-gradient(135deg, #fff, #00e676); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .landing-subtitle { font-size: 1em; color: #555; margin-bottom: 30px; }
        
        .choices-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; width: 100%; }
        
        .choice-card {
            width: 100%; min-height: 250px;
            background: linear-gradient(145deg, #111, #080808);
            border-radius: 20px; cursor: pointer; transition: 0.2s;
            border: 1px solid #222; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px 15px;
        }
        .choice-card:active { transform: scale(0.98); border-color: var(--primary-color); }
        .choice-card img { width: 70px; height: 70px; margin-bottom: 10px; }
        .choice-card h2 { font-size: 1.4em; margin: 0; }
        .choice-card p { color: #666; font-size: 0.9em; margin-top: 5px; }

        /* Content Pages */
        #minecraft-page, #roblox-page { display: none; }
        .container { 
            width: 100%; margin: 60px auto 20px auto; padding: 0 0 20px 0; 
            background: transparent; border: none; position: relative; 
        }
        
        /* Fixed Back Button for Mobile */
        .back-btn { 
            position: fixed; top: 70px; right: 10px; 
            background: rgba(0,0,0,0.9); border: 1px solid #333;
            font-size: 0.8em; padding: 8px 15px; z-index: 999;
            border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.98); overflow-y: auto; padding-top: 20px; }
        .modal-content { 
            background: #0a0a0a; margin: 10px; padding: 30px 20px; border-radius: 20px; width: calc(100% - 20px); 
            border: 1px solid #222; text-align: center; position: relative; min-height: auto;
        }
        .modal-content h2 { font-size: 1.4em; }
        .modal-content input { 
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; font-size: 16px; /* Prevents zoom */
            border: 1px solid #333; background: #000; color: white; 
        }
        .close-btn { top: 10px; left: 10px; font-size: 24px; }
        .modal-link { font-size: 0.9em; }
        
        /* Header */
        header { padding: 20px 15px; margin-bottom: 15px; border-bottom: 1px solid #111; }
        .animated-gif { width: 100px; border-radius: 10px; box-shadow: 0 0 15px rgba(76, 175, 50, 0.2); margin-bottom: 10px; }
        header h1 { font-size: 1.6em; letter-spacing: 0; }
        header p { font-size: 0.8em; }

        /* Cards */
        .balance-display { background: rgba(205, 127, 50, 0.1); padding: 5px 10px; border-radius: 6px; display: inline-flex; font-size: 0.9em; border: 1px solid rgba(205, 127, 50, 0.2); margin-bottom: 10px; }
        .balance-count { font-size: 1.1em; font-weight: 900; color: var(--bronze-color); }
        
        .section { margin-bottom: 20px; padding: 0 10px; }
        .section h2 { font-size: 1.2em; margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); display: inline-block; padding-bottom: 5px; }
        .card-grid { display: flex; flex-direction: column; gap: 15px; }
        
        .card { background: #0a0a0a; padding: 15px; border-radius: 15px; border: 1px solid #1a1a1a; }
        .rank-image { height: 80px; margin-bottom: 10px; }
        
        .btn { padding: 10px 20px; font-size: 0.9em; width: 100%; margin-top: 5px; }
        .btn-bronze { box-shadow: none; }
        
        .server-status { 
            margin: 0 10px 20px 10px; padding: 20px 15px; border-radius: 15px;
            border: 1px solid #1a1a1a; 
        }
        .status-text { font-size: 18px; }
        .ip-box { padding: 8px 15px; font-size: 0.8em; }
        
        .action-btns-container {
            display: flex; flex-direction: column; gap: 8px; padding: 0 10px; margin-bottom: 20px;
        }
        .action-btns-container .btn { width: 100%; display: flex; justify-content: center; }

        /* Inventory Mobile */
        .inventory-modal-content { width: 100%; height: 100%; margin: 0; border-radius: 0; border: none; }
        .inv-header { padding: 15px; background: #000; border-bottom: 1px solid #222; }
        .inv-body { flex-direction: column; }
        .inv-grid { 
            flex: none; height: 45vh; overflow-y: auto; padding: 15px; 
            display: flex; flex-wrap: wrap; align-content: start; gap: 10px; 
            background: #050505; border-bottom: 1px solid #111;
        }
        .inv-slot { width: calc(25% - 10px); aspect-ratio: 1; border-width: 1px; }
        
        .inv-details { 
            flex: 1; padding: 20px 15px; overflow-y: auto; align-items: stretch;
        }
        .inv-details-content { text-align: center; margin-bottom: 20px; }
        .inv-details img { width: 60px; height: 60px; }
        .inv-details h3 { font-size: 1.2em; }

        /* Referral Box Mobile */
        .referral-box { padding: 15px; background: #0a0a0a; border-radius: 12px; border: 1px solid #222; }
        .referral-title { font-size: 0.95em; }
        .referral-link-display { flex-wrap: wrap; }
        .referral-link-input { width: 100%; margin-bottom: 5px; font-size: 0.8em; }
        .referral-copy-btn { width: 100%; }

        /* Toast */
        #toast-container { bottom: 20px; right: 10px; left: 10px; align-items: center; }
        .toast { width: 100%; font-size: 0.9em; justify-content: center; border-width: 1px; }
        
        /* Desktop Tweaks */
        @media (min-width: 768px) {
            .container { width: 95%; max-width: 1400px; margin: 90px auto 30px auto; background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(10px); padding: 25px; border-radius: 20px; border: 1px solid var(--glass-border); }
            .landing-logo { width: 140px; height: 140px; }
            .landing-title { font-size: 3.5em; }
            .choices-container { flex-direction: row; }
            .choice-card { min-height: 420px; }
            .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
            .action-btns-container { flex-direction: row; padding: 0; }
            .btn { width: auto; }
            .back-btn { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.05); }
            .inv-grid { height: auto; flex: 2; display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); }
            .inv-slot { width: 100%; }
            .referral-link-input { width: auto; margin-bottom: 0; }
            .referral-copy-btn { width: auto; }
        }
    </style>
</head>
<body>

<div class="bg-animation"></div>

<!-- Header -->
<div class="global-user-bar">
    <div class="brand-logo" onclick="goHome()">STORE 4AIKRO</div>
    <div id="auth-btn-container" class="auth-actions"></div>
</div>

<!-- Landing -->
<div id="landing-page">
    <img src="newlogosite.gif" alt="Logo" class="landing-logo">
    <h1 class="landing-title">Choose Path</h1>
    <p class="landing-subtitle">Exclusive content for elite players.</p>
    <div class="choices-container">
        <div class="choice-card" onclick="showPage('roblox')">
            <img src="logoroblox.png" alt="Roblox">
            <h2>ROBLOX</h2>
            <p>Endless possibilities.</p>
        </div>
        <div class="choice-card" onclick="showPage('minecraft')">
            <img src="logominecraft.png" alt="Minecraft">
            <h2>MINECRAFT</h2>
            <p>Official Java Servers.</p>
        </div>
    </div>
</div>

<!-- Roblox -->
<div id="roblox-page">
    <div class="container">
        <button class="user-btn back-btn" onclick="goHome()">‚¨Ö Back</button>
        <header><h1>ROBLOX</h1><p>Coming Soon</p></header>
    </div>
</div>

<!-- Minecraft -->
<div id="minecraft-page">
    <div class="container">
        <button class="user-btn back-btn" onclick="goHome()">‚¨Ö Back</button>
        <header>
            <img src="standard_1.gif" alt="GIF" class="animated-gif">
            <div class="header-text">
                <h1>‚öîÔ∏è 4AIKRO_S4 ‚öîÔ∏è</h1>
                <p>UPDATE: 1</p>
            </div>
        </header>

        <div class="server-status">
            <div class="status-text" id="status-text">Checking...</div>
            <span class="status-dot" id="status-dot"></span>
            <div class="status-info">
                <div id="player-count"></div>
                <div id="server-version"></div>
            </div>
            <div class="ip-box" onclick="copyIP()"><strong>IP:</strong> <span id="server-ip">cities-declare.gl.joinmc.link</span> üìã</div>
        </div>

        <div class="action-btns-container">
            <a href="https://discord.gg/gMrHAzvERJ" target="_blank" class="btn" style="background:#5865F2;">Discord</a>
            <a href="https://www.mediafire.com/file/eyavtrl589c7s5x/mods_serveur_4AIKRO_S4.rar/file" class="btn" target="_blank">Download Mods</a>
            <button class="btn btn-rules" onclick="openModal('rules-modal')">‚öñÔ∏è Rules</button>
        </div>

        <div class="section">
            <h2>üíé Ranks & Gifts</h2>
            <div class="card-grid">
                <div class="card">
                    <img src="gift.png" alt="Daily Gift" class="rank-image">
                    <h3>Daily Gift</h3>
                    <p>Free gift every 24h.</p>
                    <div class="balance-display" id="key-balance-box" style="display:none;">
                        <span>Balance:</span>
                        <span class="balance-count" id="key-balance-num">0</span>
                    </div>
                    <div id="key-display-area" style="display:none; margin-top:10px;">
                        <div style="font-size:0.9em; color:#aaa;">Wait <span id="timer-display">00:00:00</span></div>
                    </div>
                    <button id="claim-key-btn" class="btn btn-bronze" onclick="claimBronzeKey()">üîë Claim Key</button>
                </div>

                <div class="card">
                    <img src="vip.jpg" alt="VIP" class="rank-image">
                    <h3>VIP Rank</h3>
                    <p>Extra perks.</p>
                    <div style="color:#cd7f32; font-weight:bold;">$2.00</div>
                    <a href="#" class="btn">Buy</a>
                </div>

                <div class="card">
                    <img src="mvp.jpg" alt="MVP" class="rank-image">
                    <h3>MVP Rank</h3>
                    <p>Full permissions.</p>
                    <div style="color:#cd7f32; font-weight:bold;">$5.00</div>
                    <a href="#" class="btn">Buy</a>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üõí Shop</h2>
            <div class="card-grid">
                <div class="card">
                    <img src="100coin.jpg" class="rank-image">
                    <h3>100 COIN</h3>
                    <div style="color:#cd7f32; font-weight:bold;">$1.00</div>
                    <a href="#" class="btn">Buy</a>
                </div>
                 <div class="card">
                    <img src="500coin.jpg" class="rank-image">
                    <h3>500 COIN</h3>
                    <div style="color:#cd7f32; font-weight:bold;">$3.00</div>
                    <a href="#" class="btn">Buy</a>
                </div>
                 <div class="card">
                    <img src="1000coin.jpg" class="rank-image">
                    <h3>1000 COIN</h3>
                    <div style="color:#cd7f32; font-weight:bold;">$5.00</div>
                    <a href="#" class="btn">Buy</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="login-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('login-modal')">&times;</span>
        <h2>Login</h2>
        <input type="text" id="login-name" placeholder="Username">
        <input type="password" id="login-code" placeholder="Code">
        <button class="btn" onclick="handleLogin()" style="width:100%;">Enter</button>
        <span class="modal-link" onclick="openForgotModal()">Forgot Code?</span>
    </div>
</div>

<div id="forgot-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('forgot-modal')">&times;</span>
        <h2>Recovery</h2>
        <input type="email" id="forgot-email" placeholder="Email">
        <button class="btn" onclick="handleForgot()" style="width:100%;">Search</button>
        <span class="modal-link" onclick="closeModal('forgot-modal'); openModal('login-modal');">Back</span>
    </div>
</div>

<div id="register-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('register-modal')">&times;</span>
        <h2>Register</h2>
        <input type="text" id="reg-name" placeholder="Username">
        <input type="password" id="reg-code" placeholder="Secret Code">
        <input type="email" id="reg-email" placeholder="Email">
        <button class="btn" onclick="handleRegister()" style="width:100%;">Create</button>
    </div>
</div>

<!-- Inventory -->
<div id="inventory-modal" class="modal">
    <div class="modal-content inventory-modal-content">
        <div class="inv-header">
            <h2>üì¶ Inventory</h2>
            <div style="display:flex; gap:5px;">
                <button class="user-btn logout-btn" onclick="logout()">Exit</button>
                <span class="close-btn" onclick="closeModal('inventory-modal')">&times;</span>
            </div>
        </div>
        <div class="inv-body">
            <div class="inv-grid" id="inv-grid"></div>
            <div class="inv-details" id="inv-details"></div>
        </div>
    </div>
</div>

<div id="rules-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('rules-modal')">&times;</span>
        <h2>‚öñÔ∏è Rules</h2>
        <p style="text-align:right; line-height:1.6;">
            üö´ <strong>No Hacking</strong><br>
            üó£Ô∏è <strong>Respect All</strong><br>
            üèóÔ∏è <strong>No Griefing</strong><br>
            üì¢ <strong>No Ads</strong>
        </p>
    </div>
</div>

<script>
    const GAME_ITEMS = {
        bronze_key: {
            id: 'bronze_key', name: 'COPPER KEY', description: 'Daily key.',
            image: 'COPPERKEY.png', rarity: 'common', max_stack: 25000
        }
    };
    const MAX_DAILY_REFERRALS = 5;
    let isProcessingReferral = false; 

    document.body.onload = function() { initApp(); };

    function initApp() { updateAuthUI(); checkReferralSystem(); }

    // === Referral Logic ===
    function checkReferralSystem() {
        const urlParams = new URLSearchParams(window.location.search);
        const referrer = urlParams.get('ref');
        if (referrer && !isProcessingReferral) {
            isProcessingReferral = true;
            const hasVisited = localStorage.getItem('visitor_counted');
            if (hasVisited) return;

            const currentLoggedIn = getCurrentUser();
            if (referrer === currentLoggedIn) return;

            let db = getDB();
            if (!db[referrer]) return;

            const today = new Date().toISOString().split('T')[0];
            if (!db[referrer].referrals || db[referrer].referrals.date !== today) {
                db[referrer].referrals = { date: today, count: 0 };
            }

            if (db[referrer].referrals.count >= MAX_DAILY_REFERRALS) return;

            if (!db[referrer].inventory) db[referrer].inventory = [];
            let itemEntry = db[referrer].inventory.find(i => i.id === 'bronze_key');
            if (itemEntry) itemEntry.count++;
            else db[referrer].inventory.push({ id: 'bronze_key', count: 1 });

            db[referrer].referrals.count++;
            localStorage.setItem('visitor_counted', 'true');
            saveDB(db);

            if (getCurrentUser() === referrer) {
                showToast("üéâ Reward! New player joined!", 'success');
                updateAuthUI();
                renderInventoryGrid();
            }
        }
    }

    // === Database ===
    function getDB() { try { return JSON.parse(localStorage.getItem('4aikro_db')) || {}; } catch (e) { return {}; } }
    function saveDB(db) { localStorage.setItem('4aikro_db', JSON.stringify(db)); }
    function getCurrentUser() { return localStorage.getItem('4aikro_session'); }
    function setCurrentUser(username) { localStorage.setItem('4aikro_session', username); }

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // === Auth UI ===
    function updateAuthUI() {
        const container = document.getElementById('auth-btn-container');
        const username = getCurrentUser();
        const isLandingVisible = document.getElementById('landing-page').style.display !== 'none';
        
        if (username) {
            const db = getDB();
            const userObj = db[username] || {};
            const oldKeys = userObj.mc_keys ? userObj.mc_keys.length : 0;
            const newItems = userObj.inventory ? userObj.inventory.reduce((sum, item) => sum + item.count, 0) : 0;
            const totalCount = oldKeys + newItems;

            container.innerHTML = `
                <div class="user-btn profile-btn" onclick="openInventoryModal()">
                    üë§ ${username} <span class="key-badge">üéí ${totalCount}</span>
                </div>
                <button class="user-btn logout-btn" onclick="logout()">Exit</button>
            `;

            const balanceNum = document.getElementById('key-balance-num');
            const balanceBox = document.getElementById('key-balance-box');
            if(balanceNum) balanceNum.innerText = totalCount;
            if(balanceBox) balanceBox.style.display = 'inline-flex';
            
            updateReferralUI(username);

        } else {
            if (isLandingVisible) {
                container.innerHTML = `<button class="user-btn" onclick="openModal('login-modal')">Login</button><button class="user-btn" onclick="openModal('register-modal')" style="background:#222;">Register</button>`;
            } else { container.innerHTML = ''; }
            const balanceBox = document.getElementById('key-balance-box');
            if(balanceBox) balanceBox.style.display = 'none';
        }
    }
    
    function updateReferralUI(username) {
        const refLinkInput = document.getElementById('ref-link-display');
        const refStats = document.getElementById('ref-stats-display');
        
        if(refLinkInput) {
            const path = window.location.origin + window.location.pathname;
            refLinkInput.value = `${path}?ref=${encodeURIComponent(username)}`;
        }
        
        const db = getDB();
        const today = new Date().toISOString().split('T')[0];
        let count = 0;
        if (db[username] && db[username].referrals && db[username].referrals.date === today) {
            count = db[username].referrals.count;
        }
        if(refStats) refStats.innerHTML = `Invites: <span>${count}/${MAX_DAILY_REFERRALS}</span>`;
    }

    function openModal(id) { document.getElementById(id).style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function openForgotModal() { closeModal('login-modal'); openModal('forgot-modal'); }

    function handleForgot() {
        const email = document.getElementById('forgot-email').value.trim();
        if(!email) { showToast("Enter email", "error"); return; }
        let db = getDB();
        let foundUser = null;
        for(let user in db) { if(db[user].email === email) { foundUser = user; break; } }
        if(foundUser) {
            showToast(`Code: <b style='color:var(--primary-color)'>${db[foundUser].code}</b>`, 'success');
            closeModal('forgot-modal');
        } else { showToast("Email not found", "error"); }
    }

    function handleLogin() {
        const name = document.getElementById('login-name').value.trim();
        const code = document.getElementById('login-code').value.trim();
        if (!name || !code) { showToast("Missing data", "error"); return; }
        let db = getDB();
        if (db[name] && db[name].code === code) {
            setCurrentUser(name); closeModal('login-modal'); updateAuthUI(); initKeyLogic();
            showToast(`Welcome ${name}`, 'success');
        } else { showToast("Wrong details", "error"); }
    }

    function handleRegister() {
        const name = document.getElementById('reg-name').value.trim();
        const code = document.getElementById('reg-code').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        if (!name || !code || !email) { showToast("Fill all fields", "error"); return; }
        let db = getDB();
        if (db[name]) { showToast("Name taken", "error"); return; }
        db[name] = { code: code, email: email, inventory: [], referrals: { date: '', count: 0 } };
        saveDB(db);
        setCurrentUser(name); closeModal('register-modal'); updateAuthUI(); initKeyLogic();
        showToast("Account Created!");
    }

    function logout() { localStorage.removeItem('4aikro_session'); updateAuthUI(); initKeyLogic(); closeModal('inventory-modal'); showToast("Logged out"); }

    // === Inventory ===
    function openInventoryModal() {
        const username = getCurrentUser();
        if (!username) return;
        let db = getDB();
        if (!db[username]) db[username] = {};
        if (!db[username].inventory) db[username].inventory = [];
        if (db[username].mc_keys && db[username].mc_keys.length > 0) {
            db[username].mc_keys.forEach(() => addItemToInventory('bronze_key', false, false));
            delete db[username].mc_keys; saveDB(db); updateAuthUI();
        }
        renderInventoryGrid(); updateReferralUI(username); openModal('inventory-modal');
    }

    function addItemToInventory(itemId, alertUser = true, checkMaxStack = true) {
        const username = getCurrentUser();
        let db = getDB();
        if (!db[username]) db[username] = {};
        if (!db[username].inventory) db[username].inventory = [];
        let itemEntry = db[username].inventory.find(i => i.id === itemId);
        const itemData = GAME_ITEMS[itemId];
        const maxStack = itemData ? itemData.max_stack : 64;
        if (itemEntry) {
            if (checkMaxStack && itemEntry.count >= maxStack) {
                if(alertUser) showToast(`Max stack (${maxStack})`, 'error'); return;
            }
            itemEntry.count++;
        } else { db[username].inventory.push({ id: itemId, count: 1 }); }
        saveDB(db); updateAuthUI();
        if(alertUser) showToast("Item added!");
    }

    function renderInventoryGrid() {
        const username = getCurrentUser();
        const db = getDB();
        let inventory = db[username]?.inventory || [];
        inventory.sort((a, b) => {
            const itemA = GAME_ITEMS[a.id]; const itemB = GAME_ITEMS[b.id];
            if(itemA.rarity !== itemB.rarity) return itemA.rarity === 'rare' ? -1 : 1;
            return b.count - a.count;
        });

        const grid = document.getElementById('inv-grid');
        const details = document.getElementById('inv-details');
        
        details.innerHTML = `
            <div class="inv-details-content">
                 <div style="flex-grow:1; display:flex; align-items:center; justify-content:center;">
                    <p style="color:#333;">Select item</p>
                </div>
            </div>
            <div class="referral-box">
                <span class="referral-title">üîó Invite Link</span>
                <span class="referral-stats" id="ref-stats-display">...</span>
                <div class="referral-link-display">
                    <input type="text" id="ref-link-display" class="referral-link-input" readonly>
                    <button class="referral-copy-btn" onclick="copyRefLink()">Copy</button>
                </div>
                <p class="referral-info">Get free keys! (Max 5/day)</p>
            </div>
        `;
        updateReferralUI(username);

        if (inventory.length === 0) {
            grid.innerHTML = '<p style="width:100%; text-align:center; color:#333; padding:20px;">Empty</p>';
            return;
        }

        grid.innerHTML = inventory.map((entry, index) => {
            const itemData = GAME_ITEMS[entry.id];
            if(!itemData) return '';
            return `
            <div class="inv-slot rarity-${itemData.rarity}" onclick="showItemDetails(${index})">
                <img src="${itemData.image}" alt="${itemData.name}">
                ${entry.count > 1 ? `<span class="item-count">x${entry.count}</span>` : ''}
            </div>`;
        }).join('');
    }

    function showItemDetails(index) {
        const username = getCurrentUser();
        const db = getDB();
        let inventory = db[username].inventory || [];
        inventory.sort((a, b) => {
            const itemA = GAME_ITEMS[a.id]; const itemB = GAME_ITEMS[b.id];
            if(itemA.rarity !== itemB.rarity) return itemA.rarity === 'rare' ? -1 : 1;
            return b.count - a.count;
        });

        const entry = inventory[index];
        const itemData = GAME_ITEMS[entry.id];
        
        document.querySelectorAll('.inv-slot').forEach(el => el.classList.remove('selected'));
        document.querySelectorAll('.inv-slot')[index].classList.add('selected');

        const details = document.getElementById('inv-details');
        let color = '#fff'; let name = 'COMMON';
        if(itemData.rarity === 'rare') { color = 'var(--rarity-rare)'; name = 'RARE'; }

        details.innerHTML = `
            <div class="inv-details-content">
                <img src="${itemData.image}" style="filter: drop-shadow(0 5px 15px ${color});">
                <h3 style="color:${color};">${itemData.name}</h3>
                <div class="rarity-text" style="color:${color};">${name}</div>
                <p>${itemData.description}</p>
                <div style="font-size:0.9em; color:#555;">Amount: ${entry.count}</div>
            </div>
            <div class="referral-box">
                <span class="referral-title">üîó Invite Link</span>
                <span class="referral-stats" id="ref-stats-display"></span>
                <div class="referral-link-display">
                    <input type="text" id="ref-link-display" class="referral-link-input" readonly>
                    <button class="referral-copy-btn" onclick="copyRefLink()">Copy</button>
                </div>
            </div>
        `;
        updateReferralUI(username);
    }
    
    function copyRefLink() {
        const input = document.getElementById('ref-link-display');
        if(input && input.value) {
            navigator.clipboard.writeText(input.value);
            showToast("Link Copied!", 'success');
        }
    }

    function openRulesModal() { openModal('rules-modal'); }

    function showPage(pageName) {
        document.getElementById('landing-page').style.display = 'none';
        document.getElementById('minecraft-page').style.display = 'none';
        document.getElementById('roblox-page').style.display = 'none';
        if (pageName === 'minecraft') {
            document.getElementById('minecraft-page').style.display = 'block';
            checkServerStatus(); initKeyLogic(); updateAuthUI();
        } else if (pageName === 'roblox') { document.getElementById('roblox-page').style.display = 'block'; updateAuthUI(); }
    }
    function goHome() { 
        document.getElementById('landing-page').style.display = 'flex';
        document.getElementById('minecraft-page').style.display = 'none';
        document.getElementById('roblox-page').style.display = 'none';
        updateAuthUI();
    }

    const COOLDOWN_TIME = 24 * 60 * 60 * 1000; 
    let timerInterval;

    function initKeyLogic() {
        const claimBtn = document.getElementById('claim-key-btn');
        const displayArea = document.getElementById('key-display-area');
        if(!claimBtn) return;
        const username = getCurrentUser();
        if (!username) { claimBtn.disabled = false; claimBtn.innerText = "üîë Login"; claimBtn.onclick = () => openModal('login-modal'); displayArea.style.display = 'none'; return; }
        const lastClaim = localStorage.getItem(`mc_keyTime_${username}`);
        if (lastClaim) {
            const nextClaimTime = parseInt(lastClaim) + COOLDOWN_TIME;
            const now = new Date().getTime();
            if (now < nextClaimTime) { claimBtn.disabled = true; claimBtn.innerText = "‚è≥ Wait"; displayArea.style.display = 'block'; startCountdown(nextClaimTime); } else { setupClaimable(); }
        } else { setupClaimable(); }
    }

    function setupClaimable() { const claimBtn = document.getElementById('claim-key-btn'); if(!claimBtn) return; claimBtn.disabled = false; claimBtn.innerText = "üîë Claim"; claimBtn.onclick = claimBronzeKey; document.getElementById('key-display-area').style.display = 'none'; }
    function claimBronzeKey() { const username = getCurrentUser(); if(!username) return; addItemToInventory('bronze_key'); localStorage.setItem(`mc_keyTime_${username}`, new Date().getTime()); initKeyLogic(); }
    function startCountdown(endTime) { clearInterval(timerInterval); const timerDisplay = document.getElementById('timer-display'); function updateTimer() { const now = new Date().getTime(); const distance = endTime - now; if (distance < 0) { clearInterval(timerInterval); setupClaimable(); } else { const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)); const seconds = Math.floor((distance % (1000 * 60)) / 1000); if(timerDisplay) timerDisplay.innerHTML = `${hours}h ${minutes}m ${seconds}s`; } } updateTimer(); timerInterval = setInterval(updateTimer, 1000); }

    function copyIP() { navigator.clipboard.writeText(document.getElementById("server-ip").innerText); showToast("IP Copied!", 'success'); }
    function checkServerStatus() {
        const statusText = document.getElementById("status-text");
        const playerElement = document.getElementById("player-count");
        statusText.innerText = "Checking...";
        statusText.classList.remove("status-online", "status-offline");
        playerElement.innerText = "";

        fetch("https://api.mcstatus.io/v2/status/java/cities-declare.gl.joinmc.link")
            .then(response => response.json())
            .then(data => {
                if (data && data.online === true) { statusText.innerText = "üü¢ Online"; statusText.classList.add("status-online"); playerElement.innerText = "Players: " + data.players.online + " / " + data.players.max; }
                else { statusText.innerText = "üî¥ Offline"; statusText.classList.add("status-offline"); }
            })
            .catch(() => { statusText.innerText = "‚ö†Ô∏è Error"; statusText.classList.add("status-offline"); });
    }
</script>
</body>
</html>
