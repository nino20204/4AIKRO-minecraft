<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STORE 4AIKRO</title>
<link rel="preload" href="newlogosite.gif" as="image">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Tajawal:wght@500;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1P984G5247"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1P984G5247');
</script>
<style>
:root{--p:#00e676;--s:#4CAF50;--b:#050505;--br:#cd7f32;--gb:rgba(255,255,255,0.08);--on:#22c55e;--off:#ef4444}
*{box-sizing:border-box}
body{font-family:'Cairo',sans-serif;margin:0;padding:0;background-color:var(--b);color:#fff;overflow-x:hidden;min-height:100vh}
html[dir="ltr"] body{direction:ltr;text-align:left}
html[dir="ltr"] .back-btn{right:auto;left:20px}
html[dir="ltr"] .close-btn{left:auto;right:15px}
.bg{position:fixed;top:0;left:0;width:100%;height:100%;background:#050505;z-index:-1}
.bg::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(0,230,118,0.03) 0%,transparent 60%);animation:rot 30s linear infinite}
@keyframes rot{from{transform:rotate(0)}to{transform:rotate(360deg)}}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
.hdr{position:fixed;top:0;left:0;width:100%;background:rgba(5,5,5,0.9);backdrop-filter:blur(20px);padding:12px 20px;display:flex;justify-content:space-between;align-items:center;z-index:1000;border-bottom:1px solid var(--gb)}
.logo{font-family:'Tajawal',sans-serif;font-size:1.8em;font-weight:900;background:linear-gradient(to right,#fff,var(--p));-webkit-background-clip:text;-webkit-text-fill-color:transparent;cursor:pointer}
.acts{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{background:rgba(255,255,255,0.05);color:#fff;border:1px solid var(--gb);padding:8px 20px;border-radius:12px;cursor:pointer;font-family:inherit;font-weight:700;font-size:0.9em;text-decoration:none;display:flex;align-items:center;gap:8px;transition:0.3s}
.btn:hover{border-color:var(--p);transform:translateY(-2px)}
.btn.p{background:rgba(0,230,118,0.1);border-color:rgba(0,230,118,0.3)}
.btn.out{background:transparent;border-color:rgba(255,50,50,0.3);color:#ff5555}
.badge{background:var(--br);color:#fff;padding:2px 8px;border-radius:20px;font-size:0.8em}
.lang{background:rgba(255,255,255,0.05);border:1px solid var(--gb);color:#fff;padding:8px 12px;border-radius:12px;cursor:pointer;font-family:inherit;font-weight:bold;font-size:0.85em;display:flex;align-items:center;gap:6px}
.lang select{background:transparent;border:0;color:#fff;font-weight:bold;cursor:pointer;outline:0}
.lang option{background:#000}
.shimmer{background:linear-gradient(90deg,#1a1a1a 0%,#2a2a2a 50%,#1a1a1a 100%);background-size:200% 100%;animation:sh 1.5s infinite;min-height:50px}
@keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
#lp{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;text-align:center;padding:100px 20px 50px}
.ll{width:150px;height:150px;border-radius:50%;border:3px solid rgba(0,230,118,0.3);box-shadow:0 0 50px rgba(0,230,118,0.3);margin-bottom:25px;animation:pl 4s infinite;background:#111}
@keyframes pl{0%,100%{box-shadow:0 0 30px rgba(0,230,118,0.2)}50%{box-shadow:0 0 60px rgba(0,230,118,0.5)}}
.lt{font-family:'Tajawal',sans-serif;font-size:3.5em;margin-bottom:10px;background:linear-gradient(135deg,#fff,var(--p));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.ls{font-size:1.2em;color:#666;margin-bottom:50px}
.cc{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:30px;justify-items:center;max-width:900px;width:100%}
.crd{width:100%;max-width:400px;min-height:420px;background:linear-gradient(145deg,rgba(20,20,20,0.8),rgba(10,10,10,0.9));backdrop-filter:blur(20px);border-radius:30px;cursor:pointer;transition:0.4s;border:1px solid rgba(255,255,255,0.05);padding:25px;box-shadow:0 20px 60px rgba(0,0,0,0.5);display:flex;flex-direction:column;align-items:center;justify-content:center}
.crd:hover{transform:translateY(-15px) scale(1.01);box-shadow:0 0 40px rgba(0,230,118,0.15)}
.crd img{width:120px;height:120px;margin-bottom:20px}
.crd h2{font-size:2em;margin:0;color:#fff}
.crd p{color:#777;margin-top:10px}
#mp,#rp{display:none}
.ct{width:95%;max-width:1400px;margin:90px auto 30px;background:rgba(15,15,15,0.6);backdrop-filter:blur(20px);padding:25px;border-radius:25px;border:1px solid var(--gb);position:relative}
.bk{position:fixed;bottom:30px;right:30px;z-index:1500;border:0;outline:0;background:rgba(0, 0,0,0.8);color:#fff;cursor:pointer;padding:15px 25px;border-radius:50px;font-size:1em;font-weight:bold;border:1px solid rgba(255,255,255,0.1);display:none}
.bk:hover{background:var(--p);color:#000}
.md{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.95);backdrop-filter:blur(15px);overflow-y:auto}
.mc{background:linear-gradient(145deg,#1a1a1a,#080808);margin:6% auto;padding:40px 30px;border-radius:30px;width:90%;max-width:420px;border:1px solid #222;text-align:center;position:relative;box-shadow:0 30px 80px rgba(0,0,0,0.7);animation:mp 0.4s}
@keyframes mp{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
.mc h2{margin-top:0;color:var(--p);margin-bottom:25px;font-size:1.8em}
.mc input{width:100%;padding:15px;margin:10px 0;border-radius:15px;border:2px solid #222;background:#000;color:#fff;text-align:center;box-sizing:border-box}
.mc input:focus{border-color:var(--p);outline:0}
.cls{position:absolute;top:20px;left:20px;font-size:30px;cursor:pointer;color:#333}
.ml{font-size:0.9em;color:#555;cursor:pointer;margin-top:20px;display:block}
.hd{display:flex;flex-direction:column;align-items:center;gap:15px;padding:50px 20px;border-bottom:1px solid rgba(255,255,255,0.05);margin-bottom:25px;text-align:center}
.ag{width:160px;border-radius:15px;box-shadow:0 0 40px rgba(76,175,50,0.3);border:2px solid rgba(255,255,255,0.05);background:#111}
.ht{display:flex;flex-direction:column;align-items:center;gap:10px}
.hd h1{margin:0;font-size:2.5em;text-transform:uppercase;letter-spacing:3px;font-family:'Tajawal',sans-serif}
.hd p{margin:0;color:#555;font-size:0.9em;background:#111;padding:5px 15px;border-radius:50px;border:1px solid #222}
.bl{background:rgba(205,127,50,0.1);padding:6px 12px;border-radius:8px;margin-bottom:8px;border:1px solid rgba(205,127,50,0.2);display:inline-flex;font-size:0.9em}
.bc{font-size:1.2em;font-weight:900;color:var(--br)}
.sec{margin-bottom:40px}
.sec h2{border-bottom:2px solid var(--p);padding-bottom:10px;color:#fff;font-size:1.6em;display:inline-block;margin-bottom:20px}
.cg{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:25px;align-items:start}
.cd{background:#111;padding:25px;border-radius:20px;text-align:center;border:1px solid #222;transition:0.3s;display:flex;flex-direction:column;justify-content:space-between;height:100%}
.cd:hover{transform:translateY(-5px);background:#151515}
.ri{width:100%;height:110px;object-fit:contain;margin-bottom:15px;filter:drop-shadow(0 5px 10px rgba(0,0,0,0.5));background:#0a0a0a;border-radius:8px}
.bt{background:linear-gradient(135deg,#4CAF50,#2E7D32);color:#fff;padding:12px 30px;border-radius:50px;border:0;cursor:pointer;font-size:1em;font-weight:700;text-decoration:none;display:inline-block;margin-top:5px;box-shadow:0 5px 15px rgba(76,175,50,0.2)}
.bt:hover{transform:translateY(-2px)}
.bt.br{background:linear-gradient(135deg,#cd7f32,#8b4513)}
.bt.rl{background:#222;border:1px solid #333}
.st{padding:30px;border-radius:20px;text-align:center;margin-bottom:30px;border:1px solid #222;background-image:linear-gradient(to bottom,rgba(0,0,0,0.7),rgba(0,0,0,0.9)),url('https://wallpapercave.com/wp/wp9336459.jpg');background-size:cover;background-position:center}
.ip{background:rgba(0,230,118,0.1);padding:10px 20px;border-radius:50px;display:inline-block;cursor:pointer;border:1px solid rgba(0,230,118,0.3);font-weight:bold;font-size:0.9em;margin-top:10px;color:#fff}
.stxt{font-size:24px;font-weight:900}
.son{color:var(--on);text-shadow:0 0 20px rgba(34,197,94,0.8)}
.soff{color:var(--off);text-shadow:0 0 20px rgba(239,68,68,0.8)}
.imc{max-width:1000px;background:#080808;border:1px solid #222;text-align:right;padding:0;display:flex;flex-direction:column;height:90vh;border-radius:25px;overflow:hidden}
.ih{padding:20px;background:linear-gradient(to left,#0a0a0a,#050505);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #111}
.ih h2{margin:0;font-size:1.4em}
.ib{display:flex;flex:1;overflow:hidden}
.ig{flex:2;padding:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:15px;overflow-y:auto;background:#050505;border-left:1px solid #111;align-content:start}
.is{aspect-ratio:1;background:#0a0a0a;border:1px solid #222;border-radius:12px;cursor:pointer;position:relative;display:flex;align-items:center;justify-content:center;padding:5px;transition:0.2s}
.is:hover{border-color:#444;transform:scale(1.05)}
.is.selected{border-color:var(--p);box-shadow:0 0 20px rgba(0,230,118,0.2)}
.is img{width:100%;height:100%;object-fit:contain}
.ic{position:absolute;bottom:4px;left:4px;background:#000;font-size:0.75em;padding:2px 6px;border-radius:6px;font-weight:bold;border:1px solid #222}
.rc{border-color:#333}
.rr{border-color:#55f;box-shadow:inset 0 0 15px rgba(85,85,255,0.2)}
.id{flex:1;padding:30px 25px;background:#080808;display:flex;flex-direction:column;align-items:center;text-align:center;overflow-y:auto;justify-content:space-between;gap:20px}
.id img{width:100px;height:100px;object-fit:contain;margin-bottom:15px;background:#111;border-radius:8px}
.id h3{margin:0 0 5px 0;font-size:1.3em}
.em{color:#333;text-align:center;margin-top:50%;font-size:1em}
.rf{margin-top:0;padding:20px;background:#0a0a0a;border-radius:15px;border:1px solid #222;width:100%;box-sizing:border-box;border-top:3px solid var(--p)}
.rt{font-size:1em;color:#fff;margin-bottom:8px;display:flex;align-items:center;gap:8px;font-weight:900}
.rs{font-size:0.9em;color:#888;margin-bottom:15px;display:block;background:#111;padding:8px;border-radius:8px}
.rs span{color:var(--p);font-weight:900;font-size:1.1em}
.rl{display:flex;gap:8px;justify-content:center;align-items:center}
.rii{flex:1;background:#000;border:1px solid #222;padding:10px;border-radius:8px;color:#ccc;font-size:0.85em;text-align:center;pointer-events:none;font-family:monospace}
.rcp{background:var(--s);border:0;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.9em;color:#fff;font-family:inherit}
#tc{position:fixed;bottom:30px;right:30px;z-index:9999;display:flex;flex-direction:column;gap:15px}
.t{background:#111;color:#fff;padding:16px 24px;border-radius:12px;border-right:4px solid var(--p);box-shadow:0 10px 30px rgba(0,0,0,0.5);animation:sl 0.4s,fo 0.5s ease 3.0s forwards;display:flex;align-items:center;gap:12px;font-size:1em;max-width:350px;border:1px solid #222}
.t.s{border-color:var(--p)}
@keyframes sl{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes fo{to{opacity:0;transform:translateX(100%)}}
@media(max-width:600px){.logo{font-size:1.4em}.ct{margin:80px 0 15px;padding:15px}.hd h1{font-size:1.8em}.ag{width:120px}.ib{flex-direction:column}.ig{flex:none;height:180px;overflow-x:auto;display:flex;flex-wrap:nowrap}.is{min-width:85px}#tc{left:15px;right:15px;bottom:15px}.t{width:100%;justify-content:center}.bk{bottom:20px;right:20px;padding:12px 20px;font-size:0.9em}}
</style>
</head>
<body>
<div class="bg"></div><div id="tc"></div>
<div class="hdr"><div class="logo" onclick="goHome()">STORE 4AIKRO</div><div class="acts"><div class="lang">üåê<select id="lang-select" onchange="changeLanguage(this.value)"><option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option><option value="en">English</option><option value="jp">Êó•Êú¨Ë™û</option></select></div><div id="auth-btn-container"></div></div></div>
<button id="mb" class="bk" onclick="goHome()">‚¨Ö Back</button>

<div id="lp"><img src="newlogosite.gif" alt="L" class="ll shimmer" onload="this.classList.remove('shimmer')"><h1 class="lt">Choose Your Path</h1><p class="ls">Exclusive content for elite players.</p><div class="cc"><div class="crd" onclick="showPage('roblox')"><img src="logoroblox.png" alt="R" class="shimmer" loading="lazy" onload="this.classList.remove('shimmer')"><h2>ROBLOX</h2><p>Endless possibilities.</p></div><div class="crd" onclick="showPage('minecraft')"><img src="logominecraft.png" alt="M" class="shimmer" loading="lazy" onload="this.classList.remove('shimmer')"><h2>MINECRAFT</h2><p>Official Java Servers.</p></div></div></div>

<div id="rp"><div class="ct"><header><h1>ROBLOX</h1><p>Coming Soon</p></header></div></div>

<div id="mp"><div class="ct"><header><img src="standard_1.gif" alt="G" class="ag shimmer" onload="this.classList.remove('shimmer')"><div class="ht"><h1>‚öîÔ∏è 4AIKRO_S4 ‚öîÔ∏è</h1><p>UPDATE: 1</p></div></header><div class="st"><div class="stxt" id="st">Checking...</div><span id="sd"></span><div class="si"><div id="pc"></div><div id="sv"></div></div><div class="ip" onclick="copyIP()"><strong>IP:</strong> <span id="si">cities-declare.gl.joinmc.link</span> üìã</div></div><div style="display:flex;justify-content:center;flex-wrap:wrap;gap:10px;margin-bottom:20px"><a href="https://discord.gg/gMrHAzvERJ" target="_blank" class="bt" style="background:#5865F2">Discord</a><a href="https://www.mediafire.com/file/eyavtrl589c7s5x/mods_serveur_4AIKRO_S4.rar/file" class="bt" target="_blank">Download Mods</a><button class="bt rl" onclick="openModal('rum')">‚öñÔ∏è Rules</button></div><div class="sec"><h2>üíé Ranks & Gifts</h2><div class="cg"><div class="cd"><div><img src="gift.png" alt="D" class="ri shimmer" loading="lazy" onload="this.classList.remove('shimmer')"><h3>Daily Gift</h3><p>Free gift every 24h.</p><div class="bl" id="kbb" style="display:none"><span>Balance:</span><span class="bc" id="kbn">0</span></div></div><div><div id="kda" style="display:none;margin-bottom:10px"><div>‚è≥ <span id="td">00:00:00</span></div></div><button id="ckb" class="bt br" onclick="claimKey()">üîë Claim Key</button></div></div><div class="cd"><div><img src="vip.jpg" alt="V" class="ri shimmer" loading="lazy" onload="this.classList.remove('shimmer')"><h3>VIP Rank</h3><p>Extra perks.</p></div><div class="price">$2.00</div><a href="#" class="btn">Buy</a></div><div class="cd"><div><img src="mvp.jpg" alt="M" class="ri shimmer" loading="lazy" onload="this.classList.remove('shimmer')"><h3>MVP Rank</h3><p>Full permissions.</p></div><div class="price">$5.00</div><a href="#" class="btn">Buy</a></div></div></div><div class="sec"><h2>üõí Item Shop</h2><div class="cg"><div class="cd"><img src="100coin.jpg" class="ri shimmer" loading="lazy" onload="this.classList.remove('shimmer')"><h3>100 COIN</h3><div class="price">$1.00</div><a href="#" class="btn">Buy</a></div><div class="cd"><img src="500coin.jpg" class="ri shimmer" loading="lazy" onload="this.classList.remove('shimmer')"><h3>500 COIN</h3><div class="price">$3.00</div><a href="#" class="btn">Buy</a></div><div class="cd"><img src="1000coin.jpg" class="ri shimmer" loading="lazy" onload="this.classList.remove('shimmer')"><h3>1000 COIN</h3><div class="price">$5.00</div><a href="#" class="btn">Buy</a></div></div></div></div></div>

<!-- Modals -->
<div id="lim" class="md"><div class="mc"><span class="cls" onclick="closeModal('lim')">&times;</span><h2>Login</h2><input type="text" id="lin" placeholder="Username"><input type="password" id="lic" placeholder="Secret Code"><button class="bt" onclick="handleLogin()" style="width:100%">Enter</button><span class="ml" onclick="openForgotModal()">Forgot Code?</span></div></div>
<div id="fom" class="md"><div class="mc"><span class="cls" onclick="closeModal('fom')">&times;</span><h2>Recovery</h2><p style="font-size:0.9em;color:#666;margin-bottom:15px">Enter your email.</p><input type="email" id="foe" placeholder="Email"><button class="bt" onclick="handleForgot()" style="width:100%">Search</button><span class="ml" onclick="closeModal('fom');openModal('lim')">Back to Login</span></div></div>
<div id="rem" class="md"><div class="mc"><span class="cls" onclick="closeModal('rem')">&times;</span><div style="font-size:3em;margin-bottom:10px">üìù</div><h2>Create Account</h2><input type="text" id="ren" placeholder="Username"><input type="password" id="rec" placeholder="Secret Code"><input type="email" id="ree" placeholder="Email"><button class="bt" onclick="handleRegister()" style="width:100%">Create</button></div></div>
<div id="inm" class="md"><div class="mc imc"><div class="ih"><h2>üì¶ Inventory</h2><span class="cls" style="font-size:24px;position:relative;top:0;left:0" onclick="closeModal('inm')">&times;</span></div><div class="ib"><div class="ig" id="igr"></div><div class="id" id="idt"><p class="em">Select an item</p></div></div></div></div>
<div id="rum" class="md"><div class="mc"><span class="cls" onclick="closeModal('rum')">&times;</span><h2>‚öñÔ∏è Server Rules</h2><div style="line-height:1.8"><p>üö´ No Hacking</p><p>üó£Ô∏è Respect All</p><p>üèóÔ∏è No Griefing</p><p>üì¢ No Ads</p></div></div></div>

<script>
// ==========================================
// CONFIGURATION & STATE
// ==========================================
const ITEMS_DATA = {
    bk: { id: 'bk', name: 'Copper Key', image: 'COPPERKEY.png', rarity: 'common', max_stack: 25000 }
};
const MAX_DAILY_REFERRALS = 5;

// ==========================================
// CORE FUNCTIONS (DATABASE & UTILS)
// ==========================================
function getDB() {
    try {
        return JSON.parse(localStorage.getItem('4aikro_db')) || {};
    } catch (e) { return {}; }
}

function saveDB(db) {
    localStorage.setItem('4aikro_db', JSON.stringify(db));
}

function getSession() { return localStorage.getItem('4aikro_session'); }
function setSession(u) { localStorage.setItem('4aikro_session', u); }

function showToast(msg, type = 's') {
    const c = document.getElementById('tc');
    const t = document.createElement('div');
    t.className = `t ${type}`;
    t.innerHTML = msg;
    c.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

// ==========================================
// DATA MIGRATION & FIXING (CRITICAL FIX)
// ==========================================
function migrateAndFixData(u) {
    let db = getDB();
    if (!db[u]) db[u] = {};
    let user = db[u];

    // 1. Ensure inventory array exists
    if (!user.inventory) user.inventory = [];
    
    // 2. Merge old 'inv' array if exists
    if (user.inv && Array.isArray(user.inv)) {
        user.inv.forEach(item => {
            if (!item || !item.id) return;
            let existing = user.inventory.find(i => i.id === item.id);
            if (existing) existing.c = (existing.c || 0) + (item.c || 1);
            else user.inventory.push({ id: item.id, c: item.c || 1 });
        });
        delete user.inv; // remove old key
    }

    // 3. Merge old 'mc_keys' if exists
    if (user.mk && Array.isArray(user.mk) && user.mk.length > 0) {
        let count = user.mk.length;
        let existing = user.inventory.find(i => i.id === 'bk');
        if (existing) existing.c = (existing.c || 0) + count;
        else user.inventory.push({ id: 'bk', c: count });
        delete user.mk; // remove old key
    }

    // 4. Clean corrupted items
    user.inventory = user.inventory.filter(i => i && i.id && !isNaN(i.c));

    saveDB(db);
    return db;
}

// ==========================================
// AUTHENTICATION
// ==========================================
function updateAuthUI() {
    const c = document.getElementById('auth-btn-container');
    const u = getSession();
    if (u) {
        // Run migration on UI update just in case
        migrateAndFixData(u);
        const db = getDB();
        const user = db[u];
        const total = user.inventory.reduce((s, i) => s + (i.c || 0), 0);
        c.innerHTML = `<div class="btn p" onclick="openInventoryModal()">üë§ ${u} <span class="badge">üéí ${total}</span></div><button class="btn out" onclick="logout()">Exit</button>`;
        
        // Update balance display on page
        const kbn = document.getElementById('kbn');
        const kbb = document.getElementById('kbb');
        if(kbn) kbn.innerText = total;
        if(kbb) kbb.style.display = 'inline-flex';
        updateReferralUI(u);
    } else {
        c.innerHTML = `<button class="btn" onclick="openModal('lim')">üîë Login</button><button class="btn" onclick="openModal('rem')" style="border-color:#cd7f32">üìù Register</button>`;
        const kbb = document.getElementById('kbb');
        if(kbb) kbb.style.display = 'none';
    }
}

function handleLogin() {
    const n = document.getElementById('lin').value.trim();
    const c = document.getElementById('lic').value.trim();
    if (!n || !c) return showToast('Missing data', 'error');
    let db = getDB();
    if (db[n] && (db[n].code === c || db[n].cd === c)) {
        setSession(n);
        closeModal('lim');
        updateAuthUI();
        initKeyTimer();
        showToast(`Welcome, ${n} üëã`);
    } else showToast('Wrong details', 'error');
}

function handleRegister() {
    const n = document.getElementById('ren').value.trim();
    const c = document.getElementById('rec').value.trim();
    const e = document.getElementById('ree').value.trim();
    if (!n || !c || !e) return showToast('Fill all fields', 'error');
    let db = getDB();
    if (db[n]) return showToast('Name taken', 'error');
    db[n] = { code: c, email: e, inventory: [], referrals: { date: '', count: 0 } };
    saveDB(db);
    setSession(n);
    closeModal('rem');
    updateAuthUI();
    initKeyTimer();
    showToast('Account created!');
}

function logout() {
    localStorage.removeItem('4aikro_session');
    updateAuthUI();
    initKeyTimer();
    closeModal('inm');
    showToast('Logged out');
}

function handleForgot() {
    const e = document.getElementById('foe').value.trim();
    if(!e) return showToast('Enter email', 'error');
    let db = getDB();
    let found = null;
    for(let u in db) if(db[u].email === e || db[u].em === e) found = u;
    if(found) {
        showToast(`‚úÖ Code: <b>${db[found].code || db[found].cd}</b>`);
        closeModal('fom');
    } else showToast('Not found', 'error');
}

// ==========================================
// INVENTORY (FIXED INTERACTION)
// ==========================================
function openInventoryModal() {
    const u = getSession();
    if(!u) return;
    openModal('inm');
    
    // Fix Data First
    migrateAndFixData(u);
    
    // Render
    renderInventory();
    updateReferralUI(u);
}

function addItem(id, alert = true) {
    const u = getSession();
    if(!u) return;
    let db = getDB();
    if (!db[u]) db[u] = {inventory: []};
    if (!db[u].inventory) db[u].inventory = [];
    
    let item = db[u].inventory.find(i => i.id === id);
    const data = ITEMS_DATA[id];
    const max = data ? data.max_stack : 64;

    if (item) {
        if (item.c >= max) {
            if(alert) showToast('Max stack reached', 'error');
            return;
        }
        item.c++;
    } else {
        db[u].inventory.push({ id: id, c: 1 });
    }
    
    saveDB(db);
    updateAuthUI();
    if(alert) showToast('Item added!');
}

function renderInventory() {
    const u = getSession();
    const g = document.getElementById('igr');
    const d = document.getElementById('idt');
    
    // Default right panel
    d.innerHTML = `<div style="flex-grow:1;display:flex;align-items:center;justify-content:center"><p class="em">Select an item</p></div>
    <div class="rf"><span class="rt">üîó Invite Friends</span><span class="rs" id="rs">...</span><div class="rl"><input type="text" id="ri" class="rii" readonly><button class="rcp" onclick="copyRef()">Copy</button></div></div>`;
    
    updateReferralUI(u);

    const db = getDB();
    if(!db[u] || !db[u].inventory) return;
    
    let inv = db[u].inventory;
    
    // Render Grid
    g.innerHTML = inv.map((item, index) => {
        const data = ITEMS_DATA[item.id];
        if(!data) return '';
        return `<div class="is rc" onclick="showItem(${index})"><img src="${data.image}">${item.c > 1 ? `<span class="ic">x${item.c}</span>` : ''}</div>`;
    }).join('');
}

function showItem(index) {
    const u = getSession();
    const db = getDB();
    const item = db[u].inventory[index];
    if(!item) return;
    
    const data = ITEMS_DATA[item.id];
    
    // Highlight selected
    document.querySelectorAll('.is').forEach((el, i) => {
        if(i === index) el.classList.add('selected');
        else el.classList.remove('selected');
    });

    const d = document.getElementById('idt');
    d.innerHTML = `
    <div style="flex-grow:1">
        <img src="${data.image}" style="width:80px;height:80px;margin-bottom:10px">
        <h3>${data.name}</h3>
        <p style="font-size:0.8em;color:#aaa">${data.name} (x${item.c})</p>
    </div>
    <div class="rf">
        <span class="rt">üîó Invite Link</span>
        <span class="rs" id="rs">...</span>
        <div class="rl"><input type="text" id="ri" class="rii" readonly><button class="rcp" onclick="copyRef()">Copy</button></div>
    </div>`;
    
    updateReferralUI(u);
}

// ==========================================
// REFERRAL SYSTEM
// ==========================================
function checkReferral() {
    const params = new URLSearchParams(window.location.search);
    const ref = params.get('ref');
    if(!ref) return;
    if(localStorage.getItem('vc')) return; // already counted
    
    const u = getSession();
    if(ref === u) return; // self referral
    
    let db = getDB();
    if(!db[ref]) return;
    
    const td = new Date().toISOString().split('T')[0];
    if(!db[ref].referrals || db[ref].referrals.date !== td) db[ref].referrals = {date:td, count:0};
    if(db[ref].referrals.count >= MAX_DAILY_REFERRALS) return;
    
    // Add item
    if(!db[ref].inventory) db[ref].inventory = [];
    let it = db[ref].inventory.find(i => i.id === 'bk');
    if(it) it.c++;
    else db[ref].inventory.push({id:'bk', c:1});
    
    db[ref].referrals.count++;
    localStorage.setItem('vc', '1');
    saveDB(db);
    
    if(getSession() === ref) {
        showToast('üéâ Reward received!', 's');
        updateAuthUI();
    }
}

function updateReferralUI(u) {
    const ri = document.getElementById('ri');
    const rs = document.getElementById('rs');
    if(ri) ri.value = `${location.origin}${location.pathname}?ref=${u}`;
    
    const db = getDB();
    const td = new Date().toISOString().split('T')[0];
    let cnt = 0;
    if(db[u] && db[u].referrals && db[u].referrals.date === td) cnt = db[u].referrals.count;
    if(rs) rs.innerHTML = `Today: <span>${cnt}/${MAX_DAILY_REFERRALS}</span>`;
}

function copyRef() {
    const i = document.getElementById('ri');
    if(i) {
        navigator.clipboard.writeText(i.value);
        showToast('Link copied!');
    }
}

// ==========================================
// KEY LOGIC
// ==========================================
const COOLDOWN = 24*60*60*1000;
let keyTimer;

function claimKey() {
    const u = getSession();
    if(!u) return;
    addItem('bk');
    localStorage.setItem('mc_keyTime_'+u, Date.now());
    initKeyTimer();
}

function initKeyTimer() {
    const btn = document.getElementById('ckb');
    const da = document.getElementById('kda');
    if(!btn) return;
    const u = getSession();
    if(!u) {
        btn.disabled = false; btn.innerText = "üîë Login"; btn.onclick = () => openModal('lim');
        da.style.display = 'none';
        return;
    }
    
    const last = localStorage.getItem('mc_keyTime_'+u);
    if(last) {
        const end = parseInt(last) + COOLDOWN;
        if(Date.now() < end) {
            btn.disabled = true; btn.innerText = "‚è≥ Wait";
            da.style.display = 'block';
            startTimer(end);
            return;
        }
    }
    btn.disabled = false; btn.innerText = "üîë Claim Key"; btn.onclick = claimKey;
    da.style.display = 'none';
}

function startTimer(end) {
    clearInterval(keyTimer);
    const td = document.getElementById('td');
    function tick() {
        const diff = end - Date.now();
        if(diff <= 0) {
            clearInterval(keyTimer);
            initKeyTimer();
        } else {
            const h = Math.floor(diff/3600000);
            const m = Math.floor((diff%3600000)/60000);
            const s = Math.floor((diff%60000)/1000);
            if(td) td.innerText = `${h}h ${m}m ${s}s`;
        }
    }
    tick();
    keyTimer = setInterval(tick, 1000);
}

// ==========================================
// GLOBAL UTILS
// ==========================================
function openModal(id) { document.getElementById(id).style.display = 'block'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function openForgotModal() { closeModal('lim'); openModal('fom'); }

function showPage(p) {
    document.getElementById('lp').style.display = 'none';
    document.getElementById('mp').style.display = 'none';
    document.getElementById('rp').style.display = 'none';
    document.getElementById('mb').style.display = 'block';
    
    if(p === 'minecraft') {
        document.getElementById('mp').style.display = 'block';
        checkStatus();
        initKeyTimer();
        updateAuthUI();
    } else if(p === 'roblox') {
        document.getElementById('rp').style.display = 'block';
    }
}

function goHome() {
    document.getElementById('lp').style.display = 'flex';
    document.getElementById('mp').style.display = 'none';
    document.getElementById('rp').style.display = 'none';
    document.getElementById('mb').style.display = 'none';
}

function copyIP() {
    navigator.clipboard.writeText(document.getElementById('si').innerText);
    showToast('IP Copied!');
}

function checkStatus() {
    const st = document.getElementById('st');
    const pc = document.getElementById('pc');
    const sv = document.getElementById('sv');
    st.innerText = 'Checking...';
    st.className = 'stxt';
    pc.innerText = ''; sv.innerText = '';
    
    fetch('https://api.mcstatus.io/v2/status/java/cities-declare.gl.joinmc.link')
    .then(r => r.json())
    .then(d => {
        if(d.online) {
            st.innerText = 'üü¢ Online'; st.classList.add('son');
            pc.innerText = `Players: ${d.players.online} / ${d.players.max}`;
            sv.innerText = `Version: ${d.version.name_clean}`;
        } else {
            st.innerText = 'üî¥ Offline'; st.classList.add('soff');
        }
    }).catch(() => {
        st.innerText = '‚ö†Ô∏è Error'; st.classList.add('soff');
    });
}

function changeLanguage(l) {
    localStorage.setItem('4aikro_lang', l);
    location.reload(); // Simple reload for full translation application
}

// Init
onload = () => {
    updateAuthUI();
    checkReferral();
};
</script>
</body>
</html>
